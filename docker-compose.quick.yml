services:
  xgboost_pipeline:
    image: python:3.10-slim
    container_name: xgboost_pipeline
    environment:
      - TRADING_DB_HOST=${TRADING_DB_HOST}
      - TRADING_DB_PORT=${TRADING_DB_PORT}
      - TRADING_DB_USER=${TRADING_DB_USER}
      - TRADING_DB_PASSWORD=${TRADING_DB_PASSWORD}
      - TRADING_DB_NAME=${TRADING_DB_NAME}
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${DB_NAME}
      - ENABLE_DB_STORAGE=${ENABLE_DB_STORAGE:-true}
      - EXCHANGE=${EXCHANGE:-binance}
      - PAIR=${PAIR:-BTCUSDT}
      - INTERVAL=${INTERVAL:-1h}
      - TRADING_HOURS=${TRADING_HOURS:-00:00-09:00}
      - TIMEZONE=${TIMEZONE:-WIB}
      - MODE=${MODE:-daily}
      - OUTPUT_DIR=/app/output_train
    volumes:
      - ./output_train:/app/output_train
      - ./.env:/app/.env:ro
      - ./logs:/app/logs
      - .:/app/source  # Mount source code
    working_dir: /app
    command: |
      sh -c "
        pip install --no-cache-dir -q \
          pymysql sqlalchemy pandas numpy joblib fastapi uvicorn pydantic \
          pytz python-multipart aiofiles requests &&
        cd /app/source &&
        python run_daily_pipeline.py
      "
    restart: unless-stopped
    profiles:
      - pipeline

  api_server:
    image: python:3.10-slim
    container_name: xgboost_api
    environment:
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${DB_NAME}
      - API_PORT=${API_PORT:-8000}
      - ENV=${ENV:-production}
      - OUTPUT_DIR=/app/output_train
    volumes:
      - ./output_train:/app/output_train:ro
      - ./.env:/app/.env:ro
      - ./logs:/app/logs
      - .:/app/source
    working_dir: /app
    ports:
      - "${API_PORT:-8000}:8000"
    command: |
      sh -c "
        pip install --no-cache-dir -q \
          pymysql sqlalchemy pandas numpy joblib fastapi uvicorn pydantic \
          pytz python-multipart aiofiles requests &&
        cd /app/source &&
        python api_server.py
      "
    restart: unless-stopped
    profiles:
      - api