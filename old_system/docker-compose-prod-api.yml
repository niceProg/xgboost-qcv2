version: '3.8'

services:
  # FastAPI Production Server
  xgboost_api_prod:
    build:
      context: .
      dockerfile: Dockerfile.prod
    container_name: xgboost_api_prod
    command: ["python", "-m", "uvicorn", "realtime_api:app", "--host", "0.0.0.0", "--port", "8000", "--workers", "4"]

    environment:
      # Database
      TRADING_DB_HOST: ${TRADING_DB_HOST}
      TRADING_DB_PORT: ${TRADING_DB_PORT}
      TRADING_DB_USER: ${TRADING_DB_USER}
      TRADING_DB_PASSWORD: ${TRADING_DB_PASSWORD}
      TRADING_DB_NAME: ${TRADING_DB_NAME}

      # Output
      OUTPUT_DIR: /app/output_train
      ENV: production

      # Performance
      WORKERS: 4
      MAX_CONNECTIONS: 1000
      TIMEOUT: 60

      # CORS
      CORS_ORIGINS: "https://test.dragonfortune.ai,https://www.quantconnect.com"

      # Notifications
      WEBHOOK_URL: ${WEBHOOK_URL}
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN}
      TELEGRAM_CHAT_ID: ${TELEGRAM_CHAT_ID}

    ports:
      - "8000:8000"

    volumes:
      - ./output_train:/app/output_train
      - ./logs:/app/logs
      - ./state:/app/state
      - ./realtime_data:/app/realtime_data

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 2G

  # Nginx Reverse Proxy with SSL
  nginx:
    image: nginx:alpine
    container_name: xgboost_nginx_prod
    ports:
      - "80:80"
      - "443:443"

    volumes:
      - ./nginx/prod.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/ssl:ro
      - ./logs/nginx:/var/log/nginx

    depends_on:
      - xgboost_api_prod

    restart: unless-stopped

  # Real-time Monitor
  realtime_monitor_prod:
    build:
      context: .
      dockerfile: Dockerfile.prod
    container_name: realtime_monitor_prod
    command: ["python", "realtime_monitor.py"]

    environment:
      TRADING_DB_HOST: ${TRADING_DB_HOST}
      TRADING_DB_PORT: ${TRADING_DB_PORT}
      TRADING_DB_USER: ${TRADING_DB_USER}
      TRADING_DB_PASSWORD: ${TRADING_DB_PASSWORD}
      TRADING_DB_NAME: ${TRADING_DB_NAME}
      OUTPUT_DIR: /app/output_train

      WEBHOOK_URL: ${WEBHOOK_URL}
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN}
      TELEGRAM_CHAT_ID: ${TELEGRAM_CHAT_ID}

    volumes:
      - ./output_train:/app/output_train
      - ./state:/app/state
      - ./realtime_data:/app/realtime_data
      - ./logs:/app/logs

    restart: unless-stopped

    depends_on:
      - xgboost_api_prod

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G

  # Redis for caching (optional)
  redis:
    image: redis:7-alpine
    container_name: xgboost_redis_prod
    ports:
      - "6379:6379"

    volumes:
      - redis_data:/data
      - ./redis/redis.conf:/etc/redis/redis.conf:ro

    command: redis-server /etc/redis/redis.conf

    restart: unless-stopped

    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 1G

  # Log Rotation
  logrotate:
    image: blacklabelops/logrotate
    container_name: xgboost_logrotate
    volumes:
      - ./logs:/logs
      - ./logrotate.conf:/etc/logrotate.conf:ro

    command: logrotate /etc/logrotate.conf

    restart: unless-stopped
    depends_on:
      - xgboost_api_prod
      - realtime_monitor_prod

volumes:
  redis_data:

networks:
  default:
    name: xgboost_prod_network